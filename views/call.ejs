<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>VideoConnect - Chat Room</title>
    <link rel="stylesheet" href="css/style.css" />
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='0.9em' font-size='90'>ðŸ“¹</text></svg>">
  </head>
  <body id="main" class="bg-dark h-screen overflow-hidden">
    <!-- Navigation Bar -->
    <nav class="glass-morphism-dark fixed top-0 left-0 right-0 z-50 px-6 py-4">
      <div class="max-w-7xl mx-auto flex justify-between items-center">
        <div class="flex items-center space-x-3">
          <div class="w-10 h-10 bg-gradient-to-br from-primary to-accent rounded-xl flex items-center justify-center">
            <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
          </div>
          <h1 class="text-2xl font-display font-bold text-white">VideoConnect</h1>
        </div>
        <div class="flex items-center space-x-4">
          <div id="connection-status" class="flex items-center space-x-2">
            <div class="w-2 h-2 bg-green-400 rounded-full animate-pulse"></div>
            <span class="text-white/70 text-sm">Connected</span>
          </div>
          <button id="videoCallBtn" class="btn-primary flex items-center space-x-2">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
            </svg>
            <span>Start Video</span>
          </button>
        </div>
      </div>
    </nav>

    <!-- Chat Section (Hidden during video call) -->
    <div id="chat-sec" class="h-full pt-20 pb-24 px-4">
      <div class="max-w-4xl mx-auto h-full">
        <div class="glass-morphism-dark rounded-2xl h-full p-6 overflow-y-auto scrollbar-hide">
          <!-- Requesting the call  -->
          <div id="Request-call" class="fixed top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 glass-morphism rounded-2xl p-8 hidden animate-fade-in z-50">
            <h2 class="text-2xl font-display font-bold text-white text-center mb-6">Incoming Video Call</h2>
            <div class="flex justify-center mb-8">
              <div class="relative">
                <div class="w-24 h-24 bg-gradient-to-br from-primary to-accent rounded-full flex items-center justify-center animate-pulse">
                  <svg class="w-12 h-12 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path>
                  </svg>
                </div>
                <div class="absolute -bottom-2 -right-2 w-8 h-8 bg-green-500 rounded-full flex items-center justify-center animate-bounce">
                  <svg class="w-5 h-5 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z"></path>
                  </svg>
                </div>
              </div>
            </div>
            <p class="text-white/70 text-center mb-8">Someone wants to video chat with you</p>
            <div class="flex space-x-4">
              <button id="Ignore-btn" class="flex-1 bg-red-500/20 text-red-400 border border-red-500/30 py-3 px-6 rounded-xl font-semibold hover:bg-red-500/30 transition-all">
                Decline
              </button>
              <button id="Accept-btn" class="flex-1 btn-primary">
                Accept
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Video Section -->
    <div id="video-sec" class="relative w-full h-screen bg-black overflow-hidden hidden">
      <!-- Remote Video -->
      <video id="remote-Video" autoplay class="object-cover w-full h-full"></video>
      
      <!-- Video Overlay Gradient -->
      <div class="absolute inset-0 bg-gradient-to-t from-black/50 via-transparent to-transparent pointer-events-none"></div>
      
      <!-- Local Video (Movable) -->
      <div id="localVideo" class="floating-video bottom-4 right-4 w-48 h-36 cursor-move">
        <video id="local-Video" autoplay muted class="w-full h-full object-cover rounded-2xl"></video>
      </div>
      <!-- Controls -->
      <div class="absolute bottom-8 left-1/2 -translate-x-1/2 flex items-center justify-center gap-4">
        <button id="muteBtn" class="control-btn bg-gray-800/80 hover:bg-gray-700/80 text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11a7 7 0 01-7 7m0 0a7 7 0 01-7-7m7 7v4m0 0H8m4 0h4m-4-8a3 3 0 01-3-3V5a3 3 0 116 0v6a3 3 0 01-3 3z"></path>
          </svg>
        </button>
        <button id="endCallBtn" class="control-btn bg-red-600/80 hover:bg-red-700/80 text-white px-6">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2M5 3a2 2 0 00-2 2v1c0 8.284 6.716 15 15 15h1a2 2 0 002-2v-3.28a1 1 0 00-.684-.948l-4.493-1.498a1 1 0 00-1.21.502l-1.13 2.257a11.042 11.042 0 01-5.516-5.517l2.257-1.128a1 1 0 00.502-1.21L9.228 3.683A1 1 0 008.279 3H5z"></path>
          </svg>
        </button>
        
        <button id="videoToggleBtn" class="control-btn bg-gray-800/80 hover:bg-gray-700/80 text-white">
          <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path>
          </svg>
        </button>
      </div>
      
      <!-- Call Timer -->
      <div class="absolute top-24 left-1/2 -translate-x-1/2 glass-morphism-dark px-6 py-2 rounded-full">
        <span id="call-timer" class="text-white font-mono">00:00</span>
      </div>
    </div>

    <!-- Typing Section -->
    <div id="Type-sec" class="fixed bottom-0 left-0 right-0 glass-morphism-dark p-4 z-40">
      <div class="max-w-4xl mx-auto">
        <form id="Type-form" class="flex items-center space-x-4">
          <input
            id="text-input"
            type="text"
            placeholder="Type a message..."
            class="flex-1 bg-white/10 backdrop-blur-sm text-white placeholder-white/50 px-6 py-3 rounded-full
            border border-white/20 focus:border-primary focus:outline-none focus:ring-2 focus:ring-primary/20 transition-all"
          />
          <button id="sendbtn" type="submit" class="btn-primary">
            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 19l9 2-9-18-9 18 9-2zm0 0v-8"></path>
            </svg>
          </button>
        </form>
      </div>
    </div>

    <!-- JAVASCRIPT -->
    <script
      src="https://cdn.socket.io/4.8.1/socket.io.min.js"
      integrity="sha384-mkQ3/7FUtcGyoppY6bz/PORYoGqOl7/aSUMn2ymDOJcapfS6PHqxhRTMh1RR0Q6+"
      crossorigin="anonymous"
    ></script>
    <script>
      const socket = io();
      let room;
      const main = document.querySelector("#main");
      const chatbox = document.querySelector("#Type-sec");
      const textBox = document.querySelector("#text-input");
      const typeform = document.querySelector("#Type-form");
      const chatSec = document.querySelector("#chat-sec");
      const videoCallBtn = document.getElementById("videoCallBtn");
      const videoSection = document.getElementById("video-sec");
      const chatSection = document.getElementById("chat-sec");
      const typingSection = document.getElementById("Type-sec");
      const endCallBtn = document.getElementById("endCallBtn");
      const RequestCall = document.getElementById("Request-call");
      const IgnoreBtn = document.getElementById("Ignore-btn");
      const AcceptBtn = document.getElementById("Accept-btn");

      // Join the room
      socket.emit("joinroom");
      socket.on("joined", function (roomname) {
        room = roomname;
      });

      // Sending chat messages
      typeform.addEventListener("submit", function (event) {
        event.preventDefault();
        socket.emit("message", { room: room, message: textBox.value });
        receiveMessage(textBox.value); // Echo message locally
        textBox.value = "";
      });
      socket.on("message", (message) => {
        attachMessage(message);
      });
      // Attach a user message
      function attachMessage(message) {
        const messageContainer = document.createElement("div");
        messageContainer.className = "mb-4 animate-slide-up";
        
        const userMessage = document.createElement("div");
        userMessage.className = "chat-bubble-received";
        userMessage.textContent = message;
        
        const timeStamp = document.createElement("div");
        timeStamp.className = "text-white/40 text-xs mt-1";
        timeStamp.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        messageContainer.appendChild(userMessage);
        messageContainer.appendChild(timeStamp);
        chatSec.querySelector('.glass-morphism-dark').appendChild(messageContainer);
        chatSec.querySelector('.glass-morphism-dark').scrollTop = chatSec.querySelector('.glass-morphism-dark').scrollHeight;
      }

      // Receive and display a message
      function receiveMessage(message) {
        const messageContainer = document.createElement("div");
        messageContainer.className = "mb-4 flex flex-col items-end animate-slide-up";
        
        const receivedMessage = document.createElement("div");
        receivedMessage.className = "chat-bubble-sent";
        receivedMessage.textContent = message;
        
        const timeStamp = document.createElement("div");
        timeStamp.className = "text-white/40 text-xs mt-1";
        timeStamp.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
        
        messageContainer.appendChild(receivedMessage);
        messageContainer.appendChild(timeStamp);
        chatSec.querySelector('.glass-morphism-dark').appendChild(messageContainer);
        chatSec.querySelector('.glass-morphism-dark').scrollTop = chatSec.querySelector('.glass-morphism-dark').scrollHeight;
      }

      // WebRTC Variables
      let localStream;
      let remoteStream;
      let peerConnection;
      const servers = {
        iceServers: [
          { urls: "stun:stun.l.google.com:19302" },
          {
            urls: "turn:TURN_SERVER_URL",
            username: "TURN_SERVER_USERNAME",
            credential: "TURN_SERVER_CREDENTIAL",
          },
        ],
      };

      // Start local stream

      async function initialize() {
        socket.on("signalingMessage", HandlingSignalingMessage);
        try {
          localStream = await navigator.mediaDevices.getUserMedia({
            video: true,
            audio: true,
          });
          document.querySelector("#local-Video").srcObject = localStream;
          initiateOffer();
        } catch (error) {
          console.error("Error accessing media devices:", error);
        }
      }

      // Initiate an offer
      const initiateOffer = async function () {
        await createPeerConnection();
        try {
          const offer = await peerConnection.createOffer();
          await peerConnection.setLocalDescription(offer);
          socket.emit("signalingMessage", {
            room: room,
            message: JSON.stringify({
              type: "offer",
              offer,
            }),
          });
        } catch (err) {
          console.error("Failed to create offer: " + err);
        }
      };

      // Create a peer connection
      function createPeerConnection() {
        peerConnection = new RTCPeerConnection(servers);
        remoteStream = new MediaStream();
        document.querySelector("#remote-Video").srcObject = remoteStream;
        localStream.getTracks().forEach((track) => {
          peerConnection.addTrack(track, localStream);
        });

        peerConnection.ontrack = (event) => {
          console.log("Received remote track:", event.track.kind);
          console.log("Adding remote track to remoteStream...");
          event.streams[0].getTracks().forEach((track) => {
            remoteStream.addTrack(track);
          });
        };

        peerConnection.onicecandidate = (event) => {
          console.log("Sending Ice Candidate");

          if (event.candidate) {
            socket.emit("signalingMessage", {
              room,
              message: JSON.stringify({
                type: "candidate",
                candidate: event.candidate,
              }),
            });
          }
        };
        peerConnection.onconnectionstatechange = () => {
          console.log(
            "connection state change",
            peerConnection.connectionState
          );
        };
      }

      const HandlingSignalingMessage = async function (message) {
        const { type, answer, offer, candidate } = JSON.parse(message);
        if (type === "offer") HandleOffer(offer);
        if (type === "answer") HandleAnswer(answer);
        if (type === "candidate" && peerConnection) {
          try {
            await peerConnection.addIceCandidate(candidate);
          } catch (err) {
            console.log(err.message);
          }
        }
        if (type === "hangup") Hangup();
      };

      const HandleOffer = async (offer) => {
        await createPeerConnection();
        try {
          await peerConnection.setRemoteDescription(offer);
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          socket.emit("signalingMessage", {
            room: room,
            message: JSON.stringify({ type: "answer", answer }),
          });
          inCall = true;
        } catch (err) {
          console.log(err.message);
        }
      };

      const HandleAnswer = async (answer) => {
        try {
          await peerConnection.setRemoteDescription(answer);
        } catch (err) {
          console.log(err.message);
        }
      };

      videoCallBtn.addEventListener("click", () => {
        socket.emit("startVideoCall", { room });
      });

      socket.on("IncomingCall", () => {
        RequestCall.classList.remove("hidden");
      });

      socket.on("CallAccepted", () => {
        initialize();
        chatSection.classList.add("hidden");
        typingSection.classList.add("hidden");
        videoSection.classList.remove("hidden");
      });

      AcceptBtn.addEventListener("click", () => {
        RequestCall.classList.add("hidden");
        chatSection.classList.add("hidden");
        typingSection.classList.add("hidden");
        initialize(); // Start the video stream
        videoSection.classList.remove("hidden");
        socket.emit("acceptCall", { room });
      });

      IgnoreBtn.addEventListener("click", () => {
        RequestCall.classList.add("hidden");
        socket.emit("rejectedCall", { room });
      });

      socket.on("CallRejected", () => {
        alert("Call rejected by the other user");
      });

      document.querySelector("#endCallBtn").addEventListener("click", () => {
        Hangup();
      });

      function Hangup() {
        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
          localStream.getTracks().forEach((track) => track.stop());

          videoSection.classList.add("hidden");
          chatSection.classList.remove("hidden");
          typingSection.classList.remove("hidden");
          socket.emit("signalingMessage", {
            room,
            message: JSON.stringify({ type: "hangup" }),
          });
          inCall = false;
        }
      }
      
      // Call timer
      let callStartTime = null;
      let timerInterval = null;
      
      function startCallTimer() {
        callStartTime = Date.now();
        timerInterval = setInterval(updateCallTimer, 1000);
      }
      
      function updateCallTimer() {
        if (!callStartTime) return;
        const elapsed = Math.floor((Date.now() - callStartTime) / 1000);
        const minutes = Math.floor(elapsed / 60).toString().padStart(2, '0');
        const seconds = (elapsed % 60).toString().padStart(2, '0');
        document.getElementById('call-timer').textContent = `${minutes}:${seconds}`;
      }
      
      function stopCallTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
        callStartTime = null;
        document.getElementById('call-timer').textContent = '00:00';
      }
      
      // Update video call start to include timer
      const originalInitialize = initialize;
      initialize = async function() {
        await originalInitialize();
        startCallTimer();
      };
      
      // Update hangup to stop timer
      const originalHangup = Hangup;
      Hangup = function() {
        originalHangup();
        stopCallTimer();
      }
      
      // Video toggle functionality
      let videoEnabled = true;
      document.getElementById('videoToggleBtn').addEventListener('click', () => {
        if (localStream) {
          const videoTrack = localStream.getVideoTracks()[0];
          if (videoTrack) {
            videoEnabled = !videoEnabled;
            videoTrack.enabled = videoEnabled;
            document.getElementById('videoToggleBtn').classList.toggle('bg-red-600/80');
            document.getElementById('videoToggleBtn').classList.toggle('bg-gray-800/80');
          }
        }
      });
      
      // Update mute button visual feedback
      document.getElementById('muteBtn').addEventListener('click', () => {
        if (localStream) {
          const audioTrack = localStream.getAudioTracks()[0];
          if (audioTrack) {
            const isMuted = !audioTrack.enabled;
            if (isMuted) {
              document.getElementById('muteBtn').classList.remove('bg-gray-800/80');
              document.getElementById('muteBtn').classList.add('bg-red-600/80');
            } else {
              document.getElementById('muteBtn').classList.remove('bg-red-600/80');
              document.getElementById('muteBtn').classList.add('bg-gray-800/80');
            }
          }
        }
      });
    </script>
  </body>
</html>
